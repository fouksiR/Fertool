<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GP Fertility Decision Support</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; background: linear-gradient(135deg, #f8f7f5 0%, #e8dfd0 100%); color: #2c2c2c; line-height: 1.6; min-height: 100vh; }
        header { padding: 2rem 5%; background: rgba(248,247,245,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(44,44,44,0.1); position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 400; color: #2c2c2c; display: flex; align-items: center; gap: 2px; text-decoration: none; }
        .logo-icon { width: 16px; height: 24px; margin: 0 -2px; }
        nav { display: flex; gap: 2rem; }
        nav a { color: #4a6741; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: opacity 0.2s; }
        nav a:hover { opacity: 0.7; }
        .container { max-width: 900px; margin: 0 auto; padding: 4rem 2rem; }
        .hero { text-align: center; margin-bottom: 3rem; }
        .hero h1 { font-family: 'Cormorant Garamond', serif; font-size: 2.5rem; font-weight: 400; color: #2c2c2c; margin-bottom: 1rem; }
        .hero p { font-size: 1rem; color: #666; }
        .search-card { background: #fff; border-radius: 16px; padding: 3rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 3rem; }
        .search-label { display: inline-block; background: rgba(74,103,65,0.15); color: #4a6741; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem; }
        .search-title { font-family: 'Cormorant Garamond', serif; font-size: 1.75rem; font-weight: 400; color: #2c2c2c; margin-bottom: 1.5rem; }
        .search-container { position: relative; margin-bottom: 1.5rem; }
        .search-input { width: 100%; border: 2px solid #e8e8e8; border-radius: 12px; padding: 1rem 5rem 1rem 1.25rem; font-size: 1rem; font-family: inherit; transition: border-color 0.2s; background: #f8f7f5; }
        .search-input:focus { outline: none; border-color: #4a6741; }
        .search-input::placeholder { color: #999; }
        .search-button { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #4a6741, #5a7d50); color: #fff; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
        .search-button:hover { opacity: 0.9; }
        .quick-searches { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .quick-search { padding: 0.5rem 1rem; background: #f8f7f5; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 0.85rem; color: #666; cursor: pointer; transition: all 0.2s; }
        .quick-search:hover { border-color: #4a6741; background: #f0f7ef; color: #2c2c2c; }

        /* ‚îÄ‚îÄ Heidi-style loading ‚îÄ‚îÄ */
        .loading { display: none; margin-top: 1.5rem; }
        .loading.active { display: block; }
        .loading-title { font-size: 0.82rem; color: #999; font-style: italic; margin-bottom: 0.5rem; }
        .loading-steps-list { list-style: none; }
        .loading-step { display: flex; align-items: center; gap: 0.6rem; padding: 0.35rem 0; font-size: 0.83rem; color: #ccc; opacity: 0; transform: translateY(3px); transition: opacity 0.3s, transform 0.3s, color 0.3s; }
        .loading-step.vis { opacity: 1; transform: translateY(0); color: #555; }
        .loading-step.done { opacity: 0.4; color: #bbb; }
        .step-spin { width: 13px; height: 13px; border-radius: 50%; border: 2px solid #ddd; border-top-color: #4a6741; animation: spin 0.75s linear infinite; flex-shrink: 0; }
        .step-check { width: 13px; height: 13px; flex-shrink: 0; font-size: 11px; color: #4a6741; }
        .step-dot { width: 13px; height: 13px; border-radius: 50%; border: 2px solid #e0e0e0; flex-shrink: 0; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .results-container { display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e8e8e8; }
        .results-container.active { display: block; }
        .result-label { font-size: 0.75rem; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; }

        /* ‚îÄ‚îÄ Response sections ‚îÄ‚îÄ */
        .response-section { border-radius: 12px; padding: 1.5rem 1.75rem; margin-bottom: 1.25rem; }
        .response-section.guideline { background: #f0f7ef; border-left: 4px solid #4a6741; }
        .response-section.specialist { background: #f3f0f8; border-left: 4px solid #6b5b95; }
        .response-section.clinical { background: #fef9f0; border-left: 4px solid #c8a45e; }
        .section-header { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; padding: 0.3rem 0.85rem; border-radius: 20px; margin-bottom: 0.35rem; color: #fff; }
        .section-header.guideline { background: #4a6741; }
        .section-header.specialist { background: #6b5b95; }
        .section-header.clinical { background: #c8a45e; }
        .evidence-note { font-size: 0.72rem; color: #999; letter-spacing: 0.3px; margin-bottom: 1rem; }
        .response-section p, .response-section li { font-size: 0.95rem; line-height: 1.85; color: #333; margin-bottom: 0.5rem; }
        .response-section ul { padding-left: 1.25rem; margin-bottom: 0.75rem; }
        .response-section li { margin-bottom: 0.35rem; }
        .response-section strong { color: #1a1a1a; font-weight: 600; }
        .calc-card { background: rgba(0,0,0,0.04); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 0.6rem; font-size: 0.9rem; }
        .calc-card-title { font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: #555; margin-bottom: 0.35rem; }
        .calc-row { margin-bottom: 0.2rem; }
        .calc-key { color: #777; }
        .calc-val { font-weight: 600; color: #1a1a1a; }
        .referral-badge { border-radius: 8px; padding: 0.75rem 1rem; margin-top: 0.75rem; font-size: 0.9rem; }
        .referral-badge.urgent { background: rgba(220,53,69,0.1); border-left: 3px solid #dc3545; }
        .referral-badge.standard { background: rgba(255,193,7,0.12); border-left: 3px solid #ffc107; }
        .referral-badge.not_needed { background: rgba(74,103,65,0.1); border-left: 3px solid #4a6741; }
        .safety-box { background: rgba(220,53,69,0.07); border-radius: 8px; padding: 0.75rem 1rem; margin-top: 0.75rem; }
        .gp-script { background: rgba(74,103,65,0.07); border-radius: 8px; padding: 0.75rem 1rem; margin-top: 0.75rem; font-style: italic; font-size: 0.9rem; }

        /* ‚îÄ‚îÄ L3 WRAPPER ‚Äî faded content + permanent top-left circles ‚îÄ‚îÄ */
        .l3-wrapper {
            position: relative;
            margin-bottom: 1.25rem;
        }
        /* The actual clinical section sits faded */
        .l3-content {
            opacity: 0.22;
            filter: blur(2.5px);
            user-select: none;
            pointer-events: none;
            /* keep border-radius */
            border-radius: 12px;
            overflow: hidden;
        }
        /* Two circles float in the TOP-LEFT of the L3 box */
        .l3-circles {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.55rem;
            z-index: 10;
        }
        .l3-circle {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.18);
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }
        .l3-circle:hover { transform: scale(1.08); box-shadow: 0 5px 16px rgba(0,0,0,0.22); }
        /* Circle 1: photo / WhatsApp */
        .l3-circle.photo {
            border: 2.5px solid #25D366;
            overflow: hidden;
            position: relative;
        }
        .l3-circle.photo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .l3-circle.photo::after {
            content: '';
            position: absolute; bottom: -1px; right: -1px;
            width: 16px; height: 16px;
            background-color: #25D366; border-radius: 50%; border: 2px solid #fef9f0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z'/%3E%3C/svg%3E");
            background-size: 9px 9px; background-position: center; background-repeat: no-repeat;
        }
        /* Circle 2: Refer button */
        .l3-circle.refer {
            background: #c8a45e;
            border: 2.5px solid #b8944e;
            flex-direction: column;
            gap: 1px;
        }
        .l3-circle.refer .refer-icon { font-size: 1.1rem; line-height: 1; }
        .l3-circle.refer .refer-label { font-size: 0.52rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #fff; line-height: 1; }
        /* Pulse ring on photo circle */
        .l3-ring {
            position: absolute; inset: -5px; border-radius: 50%;
            border: 2px solid rgba(37,211,102,0.5);
            animation: ringPulse 2.5s ease-out infinite;
            pointer-events: none;
        }
        @keyframes ringPulse { 0%{transform:scale(1);opacity:.7} 70%{transform:scale(1.4);opacity:0} 100%{transform:scale(1.4);opacity:0} }

        /* Disclaimer strip at bottom of L3 wrapper */
        .l3-disclaimer {
            background: #fdf6ea;
            border: 1.5px solid rgba(200,164,94,0.35);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 0.7rem 1.25rem 0.7rem 1.25rem;
            display: flex; align-items: center; gap: 0.5rem;
            margin-top: -4px;
        }
        .l3-disclaimer-icon { font-size: 0.85rem; flex-shrink: 0; }
        .l3-disclaimer-text { font-size: 0.75rem; color: #a07830; font-weight: 500; line-height: 1.4; flex: 1; }
        .l3-disclaimer-text strong { color: #7a5010; }

        /* ‚îÄ‚îÄ Feedback ‚îÄ‚îÄ */
        .feedback-row { display: flex; align-items: center; gap: 0.75rem; margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid #eee; }
        .feedback-label { font-size: 0.8rem; color: #999; }
        .feedback-btn { background: #f0f0f0; border: none; border-radius: 8px; padding: 0.4rem 0.9rem; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
        .feedback-btn:hover { background: #e0e0e0; }
        .feedback-btn.active-up { background: #d4edda; }
        .feedback-btn.active-down { background: #f8d7da; }
        .meta-row { text-align: right; font-size: 0.72rem; color: #bbb; margin-top: 0.5rem; }

        /* ‚îÄ‚îÄ Sources ‚îÄ‚îÄ */
        .result-sources { margin-top: 1.5rem; padding-top: 1.25rem; border-top: 1px solid #f0f0f0; }
        .sources-header { font-size: 0.7rem; font-weight: 600; color: #bbb; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.6rem; }
        .source-item { display: flex; align-items: baseline; gap: 0.5rem; padding: 0.35rem 0; border-bottom: 1px solid #f8f8f8; }
        .source-item:last-child { border-bottom: none; }
        .source-num { font-size: 0.72rem; color: #ccc; font-weight: 600; flex-shrink: 0; min-width: 1.1rem; }
        .source-name { font-size: 0.83rem; color: #555; font-weight: 500; line-height: 1.4; }
        .source-page { font-size: 0.75rem; color: #bbb; flex-shrink: 0; }

        /* ‚îÄ‚îÄ Skeleton ‚îÄ‚îÄ */
        .section-skeleton { border-radius: 12px; padding: 1.5rem 1.75rem; margin-bottom: 1.25rem; min-height: 100px; }
        .section-skeleton.guideline { background: #f0f7ef; border-left: 4px solid #4a6741; }
        .section-skeleton.specialist { background: #f3f0f8; border-left: 4px solid #6b5b95; }
        .section-skeleton.clinical { background: #fef9f0; border-left: 4px solid #c8a45e; }
        .section-skeleton .skel-header { width: 110px; height: 22px; border-radius: 20px; margin-bottom: 0.6rem; }
        .section-skeleton.guideline .skel-header { background: rgba(74,103,65,0.2); }
        .section-skeleton.specialist .skel-header { background: rgba(107,91,149,0.2); }
        .section-skeleton.clinical .skel-header { background: rgba(200,164,94,0.2); }
        .skel-line { height: 10px; border-radius: 6px; margin-bottom: 10px; background: linear-gradient(90deg,rgba(0,0,0,0.04) 25%,rgba(0,0,0,0.08) 50%,rgba(0,0,0,0.04) 75%); background-size: 200% 100%; animation: shimmer 1.5s ease-in-out infinite; }
        .skel-line:nth-child(2){width:90%} .skel-line:nth-child(3){width:75%} .skel-line:nth-child(4){width:85%} .skel-line:nth-child(5){width:60%}
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .section-slot { opacity: 0; transform: translateY(6px); transition: opacity 0.35s ease, transform 0.35s ease; }
        .section-slot.revealed { opacity: 1; transform: translateY(0); }

        /* ‚îÄ‚îÄ Tools ‚îÄ‚îÄ */
        .tools-section { margin-top: 4rem; }
        .tools-label { font-size: 0.75rem; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1.5rem; text-align: center; }
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .tool-card { background: #fff; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-decoration: none; color: inherit; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; min-height: 200px; }
        .tool-card-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; opacity: 0.45; }
        .tool-card-content { position: relative; z-index: 1; background: rgba(255,255,255,0.82); padding: 1.25rem 1.5rem; border-radius: 12px; }
        .tool-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .tool-card:hover .tool-card-video { opacity: 0.55; }
        .tool-badge { display: inline-block; background: linear-gradient(135deg, #6b5b95, #8b7db5); color: #fff; padding: 0.3rem 0.75rem; border-radius: 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; }
        .tool-card h3 { font-family: 'Cormorant Garamond', serif; font-size: 1.35rem; font-weight: 600; color: #1a1a1a; margin-bottom: 0.75rem; }
        .tool-card p { font-size: 0.9rem; color: #444; margin-bottom: 1rem; }
        .tool-meta { font-size: 0.8rem; color: #777; }

        footer { background: rgba(248,247,245,0.95); border-top: 1px solid rgba(44,44,44,0.1); padding: 3rem 5%; margin-top: 4rem; }
        .footer-text { font-size: 0.8rem; color: #666; line-height: 1.8; max-width: 900px; margin: 0 auto; }
        .footer-text strong { color: #2c2c2c; font-weight: 600; display: block; margin-top: 0.5rem; }

        /* ‚îÄ‚îÄ WhatsApp fixed widget ‚Äî bottom LEFT ‚îÄ‚îÄ */
        .whatsapp-widget { position: fixed; bottom: 30px; left: 30px; z-index: 1000; display: flex; align-items: center; gap: 12px; animation: fadeInUp 0.5s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .whatsapp-button { width: 58px; height: 58px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.3s; text-decoration: none; position: relative; overflow: hidden; border: 3px solid #25D366; flex-shrink: 0; }
        .whatsapp-button img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .whatsapp-button::after { content: ''; position: absolute; bottom: -2px; right: -2px; width: 18px; height: 18px; background-color: #25D366; border-radius: 50%; border: 2px solid white; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='white' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z'/%3E%3C/svg%3E"); background-size: 10px 10px; background-position: center; background-repeat: no-repeat; }
        .whatsapp-button:hover { transform: scale(1.08); }
        .wa-ring { position: absolute; inset: -4px; border-radius: 50%; border: 2px solid rgba(37,211,102,0.5); animation: ringPulse 2.4s ease-out infinite; pointer-events: none; }
        .whatsapp-tooltip { background: #fff; padding: 8px 14px; border-radius: 22px; box-shadow: 0 2px 10px rgba(0,0,0,.1); font-size: 0.8rem; font-weight: 500; color: #2c2c2c; white-space: nowrap; line-height: 1.4; opacity: 0; transform: translateX(-8px); transition: all 0.3s ease; pointer-events: none; order: 2; }
        .whatsapp-tooltip .tt-sub { font-size: 0.7rem; color: #888; display: block; margin-top: 1px; }
        .whatsapp-widget:hover .whatsapp-tooltip { opacity: 1; transform: translateX(0); }

        @media (max-width: 768px) {
            .hero h1 { font-size: 2rem; }
            .search-card { padding: 2rem 1.5rem; }
            .search-button { position: static; transform: none; width: 100%; margin-top: 0.75rem; }
            .tools-grid { grid-template-columns: 1fr; }
            nav { display: none; }
            .whatsapp-widget { bottom: 20px; left: 20px; }
            .whatsapp-button { width: 52px; height: 52px; border-width: 2px; }
            .whatsapp-tooltip { display: none; }
            .l3-circles { top: 0.75rem; left: 0.75rem; }
            .l3-circle { width: 44px; height: 44px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <a href="index.html" class="logo">
            <span>fert</span>
            <svg class="logo-icon" viewBox="0 0 16 40" xmlns="http://www.w3.org/2000/svg">
                <ellipse cx="8" cy="8" rx="5" ry="7" fill="#2c2c2c"/>
                <path d="M 8 15 Q 7 23, 10 31 Q 8 35, 7 40" stroke="#2c2c2c" stroke-width="2.5" fill="none" stroke-linecap="round"/>
            </svg>
            <span>le</span>
        </a>
        <nav>
            <a href="index.html">Search</a>
            <a href="egg-freezing-calculator.html">Egg Freezing</a>
            <a href="endometriosis-landing.html">Endometriosis</a>
            <a href="fertility-assessment.html">Assessment</a>
            <a href="amh-guide.html">AMH Guide</a>
            <a href="fertool-cpd-learning-hub.html">CPD Hub</a>
        </nav>
    </div>
</header>

<div class="container">
    <div class="hero">
        <h1>Clinical Support for Fertility Care</h1>
        <p>Evidence-based guidance</p>
    </div>

    <div class="search-card" id="search">
        <span class="search-label">Guidelines</span>
        <h2 class="search-title">How can I help?</h2>
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput"
                placeholder="Ask about AMH, referral criteria, initial investigations..."
                onkeypress="handleEnter(event)">
            <button class="search-button" onclick="performSearch()">Search</button>
        </div>
        <div class="quick-searches">
            <span class="quick-search" onclick="quickSearch('AMH interpretation')">AMH interpretation</span>
            <span class="quick-search" onclick="quickSearch('When to refer')">Referral criteria</span>
            <span class="quick-search" onclick="quickSearch('Initial workup')">Initial workup</span>
        </div>

        <div class="loading" id="loading">
            <div class="loading-title" id="loadingTitle">Searching guidelines‚Ä¶</div>
            <ul class="loading-steps-list">
                <li class="loading-step" id="ls0"><span class="step-dot" id="ls0i"></span><span id="ls0t">Reading fertility guidelines</span></li>
                <li class="loading-step" id="ls1"><span class="step-dot" id="ls1i"></span><span id="ls1t">Retrieving specialist knowledge</span></li>
                <li class="loading-step" id="ls2"><span class="step-dot" id="ls2i"></span><span id="ls2t">Synthesising clinical context</span></li>
            </ul>
        </div>

        <div class="results-container" id="results">
            <div class="result-label">Response</div>
            <div id="resultContent"></div>
            <div class="result-sources" id="resultSources"></div>
        </div>
    </div>

    <div class="tools-section">
        <div class="tools-label">Additional Tools</div>
        <div class="tools-grid">
            <a href="amh-guide.html" class="tool-card">
                <video class="tool-card-video" autoplay loop muted playsinline><source src="AMH.mp4" type="video/mp4"></video>
                <div class="tool-card-content"><span class="tool-badge">Guide</span><h3>Understanding AMH</h3><p>Interactive guide to ovarian reserve testing</p><div class="tool-meta">Age-specific normograms</div></div>
            </a>
            <a href="egg-freezing-calculator.html" class="tool-card">
                <video class="tool-card-video" autoplay loop muted playsinline><source src="Egg_freezing_outcomes.mp4" type="video/mp4"></video>
                <div class="tool-card-content"><span class="tool-badge">Calculator</span><h3>Egg Freezing Outcomes</h3><p>Success rates by age and egg number</p><div class="tool-meta">2,891 patients</div></div>
            </a>
            <a href="endometriosis-landing.html" class="tool-card">
                <video class="tool-card-video" autoplay loop muted playsinline><source src="Endometriosis.mp4" type="video/mp4"></video>
                <div class="tool-card-content"><span class="tool-badge">Interactive</span><h3>Endometriosis &amp; Fertility</h3><p>How endometriosis affects reproduction</p><div class="tool-meta">La Marca et al. 2025</div></div>
            </a>
            <a href="fertility-assessment.html" class="tool-card">
                <video class="tool-card-video" autoplay loop muted playsinline><source src="When_to_seek_help.mp4" type="video/mp4"></video>
                <div class="tool-card-content"><span class="tool-badge">Assessment</span><h3>When to Seek Help</h3><p>Timing for fertility evaluation</p><div class="tool-meta">ASRM guidelines</div></div>
            </a>
            <a href="fertool-cpd-learning-hub.html" class="tool-card">
                <video class="tool-card-video" autoplay loop muted playsinline><source src="cpd-hero.mp4" type="video/mp4"></video>
                <div class="tool-card-content"><span class="tool-badge" style="background:linear-gradient(135deg,#4a6741,#6b8f5e);">CPD Education</span><h3>CPD Learning Hub</h3><p>Accredited fertility &amp; pre-pregnancy modules for GPs</p><div class="tool-meta">ASRM 2022 ¬∑ RANZCOG 2024</div></div>
            </a>
        </div>
    </div>
</div>

<footer>
    <div class="footer-text">
        <strong>Clinical Decision Support Tool</strong>
        Evidence-based guidance from published fertility guidelines (ASRM, RANZCOG, ESHRE). All information requires independent verification and clinical judgment. Not a substitute for specialist consultation.
        <strong>Medical Disclaimer</strong>
        For informational and educational purposes only. Individual patient care decisions require consultation with qualified healthcare professionals.
        <strong>Copyright &amp; Intellectual Property</strong>
        &copy; 2025 Fertool. All rights reserved.
        <strong>Professional Use Only</strong>
    </div>
</footer>

<!-- Fixed WhatsApp widget ‚Äî bottom LEFT -->
<div class="whatsapp-widget" id="whatsappWidget">
    <a href="https://wa.me/61493835221?text=Hi%20Yuval%2C%20I'd%20like%20to%20discuss%20a%20fertility%20case..."
       target="_blank" class="whatsapp-button" id="whatsappBtn" aria-label="Chat on WhatsApp">
        <div class="wa-ring"></div>
        <img src="yuval-photo.jpg" alt="Yuval">
    </a>
    <div class="whatsapp-tooltip">
        Discuss with Dr Fouks
        <span class="tt-sub">Specialist consultation available</span>
    </div>
</div>

<script>
const API_URL  = 'https://fertility-gp-backend-532857641879.australia-southeast2.run.app';
const WA_HREF  = 'https://wa.me/61493835221?text=Hi%20Yuval%2C%20I%27d%20like%20to%20discuss%20a%20fertility%20case...';
let _lastQueryId = null, _lastQuery = '', _stepTimers = [];

function handleEnter(e) { if (e.key === 'Enter') performSearch(); }
function quickSearch(q) { document.getElementById('searchInput').value = q; performSearch(); }

function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function cleanSourceName(raw) {
    if (!raw) return '';
    return raw
        .replace(/^\/content\/drive\/MyDrive\/GP_Outreach_Melbourne\/GP\/GPFST\/Guidlines folder Path\s*\//i,'')
        .replace(/^\/content\/drive\/MyDrive\/GP_Outreach_Melbourne\/GP\/GPFST\//i,'')
        .replace(/^.*[\/\\]/,'')
        .replace(/\.(txt|pdf)$/i,'')
        .replace(/[_\-]/g,' ')
        .replace(/\b\w/g, function(x){ return x.toUpperCase(); })
        .trim();
}

function isSpecialistChunk(raw) {
    return /speroff|specialist_notes?|reproductive_physiology|clinical_endocrinology|special_topics/i.test(raw);
}

/* ‚îÄ‚îÄ Loading steps ‚îÄ‚îÄ */
var STEP_LABELS_DEFAULT = ['Reading fertility guidelines','Retrieving specialist knowledge','Synthesising clinical context'];

function startLoadingSteps(query) {
    _stepTimers.forEach(clearTimeout); _stepTimers = [];
    var t = query.length > 30 ? query.slice(0,30)+'‚Ä¶' : query;
    var labels = ['Searching guidelines for "'+t+'"', 'Retrieving specialist knowledge', 'Synthesising clinical context'];
    document.getElementById('loading').classList.add('active');

    labels.forEach(function(label, i) {
        _stepTimers.push(setTimeout(function() {
            if (i > 0) {
                var pEl = document.getElementById('ls'+(i-1));
                if (pEl) { pEl.classList.remove('vis'); pEl.classList.add('done'); }
                var pIco = document.getElementById('ls'+(i-1)+'i');
                if (pIco) pIco.outerHTML = '<span class="step-check" id="ls'+(i-1)+'i">‚úì</span>';
            }
            var el  = document.getElementById('ls'+i);
            var ico = document.getElementById('ls'+i+'i');
            var txt = document.getElementById('ls'+i+'t');
            if (el)  el.classList.add('vis');
            if (ico) ico.outerHTML = '<span class="step-spin" id="ls'+i+'i"></span>';
            if (txt) txt.textContent = label;
        }, i * 950));
    });
}

function stopLoadingSteps() {
    _stepTimers.forEach(clearTimeout); _stepTimers = [];
    document.getElementById('loading').classList.remove('active');
    [0,1,2].forEach(function(i){
        var el=document.getElementById('ls'+i), ico=document.getElementById('ls'+i+'i'), txt=document.getElementById('ls'+i+'t');
        if(el)  { el.classList.remove('vis','done'); }
        if(ico) ico.outerHTML = '<span class="step-dot" id="ls'+i+'i"></span>';
        if(txt) txt.textContent = STEP_LABELS_DEFAULT[i];
    });
}

/* ‚îÄ‚îÄ WhatsApp pulse ‚îÄ‚îÄ */
function pulseWhatsApp() {
    var btn = document.getElementById('whatsappBtn');
    if (!btn) return;
    btn.classList.remove('wa-attention'); void btn.offsetWidth;
    btn.classList.add('wa-attention');
    btn.addEventListener('animationend', function(){ btn.classList.remove('wa-attention'); }, {once:true});
}

/* ‚îÄ‚îÄ Skeletons ‚îÄ‚îÄ */
function makeSkel(type) {
    return '<div class="section-skeleton '+type+'"><div class="skel-header"></div><div class="skel-line"></div><div class="skel-line"></div><div class="skel-line"></div><div class="skel-line"></div><div class="skel-line"></div></div>';
}
function showSkeletons() {
    document.getElementById('resultContent').innerHTML =
        '<div id="sl-g" class="section-slot">'+makeSkel('guideline')+'</div>'+
        '<div id="sl-s" class="section-slot">'+makeSkel('specialist')+'</div>'+
        '<div id="sl-c" class="section-slot">'+makeSkel('clinical')+'</div>'+
        '<div id="sl-f"></div>';
    document.getElementById('resultSources').innerHTML = '';
    document.getElementById('results').classList.add('active');
    document.getElementById('results').scrollIntoView({behavior:'smooth',block:'nearest'});
    setTimeout(function(){ var s=document.getElementById('sl-g'); if(s) s.classList.add('revealed'); },50);
    setTimeout(function(){ var s=document.getElementById('sl-s'); if(s) s.classList.add('revealed'); },200);
    setTimeout(function(){ var s=document.getElementById('sl-c'); if(s) s.classList.add('revealed'); },350);
}
function revealSlot(id, html) {
    var el=document.getElementById(id); if(!el) return;
    el.classList.remove('revealed');
    setTimeout(function(){ el.innerHTML=html; void el.offsetHeight; el.classList.add('revealed'); },80);
}

/* ‚îÄ‚îÄ Renderers ‚îÄ‚îÄ */
function renderGuidelines(g) {
    if (!g) return '';
    var h='<div class="response-section guideline"><div class="section-header guideline">Guidelines</div><div class="evidence-note">Published clinical guidelines ¬∑ ASRM, RANZCOG, ESHRE</div>';
    if (!g.guideline_statements||!g.guideline_statements.length) {
        h+='<p><em>No specific guideline retrieved for this query.</em></p>';
    } else {
        h+='<ul>';
        g.guideline_statements.forEach(function(s){
            h+='<li>'+(s.directly_answers_query?'‚úì':'~')+' '+esc(s.statement);
            if(s.source) h+=' <span style="font-size:.8em;color:#666;">('+esc(s.source)+')</span>';
            h+='</li>';
        });
        h+='</ul>';
    }
    if(g.gaps) h+='<p style="color:#888;font-size:.88em;margin-top:.4rem;">Gap: '+esc(g.gaps)+'</p>';
    return h+'</div>';
}

function renderSpecialist(s) {
    if (!s) return '';
    var h='<div class="response-section specialist"><div class="section-header specialist">Specialist Insight</div><div class="evidence-note">Expert perspective ¬∑ clinical knowledge and practice experience</div>';
    if(s.specialist_perspective) h+='<p>'+esc(s.specialist_perspective)+'</p>';
    if(s.common_pitfalls&&s.common_pitfalls.length){ h+='<p><strong>Common pitfalls:</strong></p><ul>'; s.common_pitfalls.forEach(function(p){h+='<li>'+esc(p)+'</li>';}); h+='</ul>'; }
    if(s.nuances&&s.nuances.length){ h+='<p><strong>Nuances:</strong></p><ul>'; s.nuances.forEach(function(n){h+='<li>'+esc(n)+'</li>';}); h+='</ul>'; }
    if(s.when_guidelines_fall_short) h+='<p><strong>When guidelines fall short:</strong> '+esc(s.when_guidelines_fall_short)+'</p>';
    return h+'</div>';
}

/* ‚îÄ‚îÄ renderClinical: faded content + two circles baked into top-left ‚îÄ‚îÄ */
function renderClinical(c, calcs) {
    if (!c) return '';

    /* Build the clinical section body */
    var body = '<div class="response-section clinical" style="margin-bottom:0; border-radius:12px 12px 0 0;">';
    body += '<div class="section-header clinical" style="margin-left:120px;">Clinical Practice</div>';
    body += '<div class="evidence-note" style="margin-left:0;">Applied guidance ¬∑ guidelines integrated with clinical context</div>';
    if(c.summary) body+='<p><strong>'+esc(c.summary)+'</strong></p>';
    if(c.key_actions&&c.key_actions.length){ body+='<p><strong>Actions:</strong></p><ul>'; c.key_actions.forEach(function(a){body+='<li>'+esc(a.action)+'</li>';}); body+='</ul>'; }
    if(calcs) Object.entries(calcs).forEach(function(e){
        var r=e[1]; if(r.error) return;
        var lbl=e[0].replace(/_/g,' ').replace(/\b\w/g,function(x){return x.toUpperCase();});
        body+='<div class="calc-card"><div class="calc-card-title">'+esc(lbl)+'</div>';
        Object.entries(r).forEach(function(kv){ if(!kv[0].startsWith('_')) body+='<div class="calc-row"><span class="calc-key">'+esc(kv[0].replace(/_/g,' '))+': </span><span class="calc-val">'+esc(Array.isArray(kv[1])?kv[1].join(', '):String(kv[1]))+'</span></div>'; });
        body+='</div>';
    });
    var ref=c.referral_recommendation||{};
    if(ref.refer){
        var cls=ref.urgency==='urgent'?'urgent':ref.urgency==='standard'?'standard':'not_needed';
        body+='<div class="referral-badge '+cls+'"><strong>Refer ['+esc((ref.urgency||'').toUpperCase())+']</strong>';
        if(ref.to) body+=' ‚Üí '+esc(ref.to);
        if(ref.reason) body+='<br><span style="font-size:.88em;">'+esc(ref.reason)+'</span>';
        body+='</div>';
    }
    if(c.safety_flags&&c.safety_flags.length){ body+='<div class="safety-box"><strong>Safety flags:</strong><ul>'; c.safety_flags.forEach(function(f){body+='<li>'+esc(f)+'</li>';}); body+='</ul></div>'; }
    if(c.suggested_workup&&c.suggested_workup.length){ body+='<p><strong>Suggested workup:</strong></p><ul>'; c.suggested_workup.forEach(function(w){body+='<li>‚Üí '+esc(w)+'</li>';}); body+='</ul>'; }
    if(c.gp_script) body+='<div class="gp-script">"'+esc(c.gp_script)+'"</div>';
    body+='</div>';

    /* Two circles ‚Äî baked into the wrapper, always visible */
    var circles =
        '<div class="l3-circles">' +
            /* Circle 1: photo / WhatsApp */
            '<a href="'+WA_HREF+'" target="_blank" class="l3-circle photo" onclick="pulseWhatsApp()" title="Discuss with Dr Fouks">' +
                '<div class="l3-ring"></div>' +
                '<img src="yuval-photo.jpg" alt="Dr Fouks">' +
            '</a>' +
            /* Circle 2: Refer button */
            '<a href="'+WA_HREF+'" target="_blank" class="l3-circle refer" onclick="pulseWhatsApp()" title="Request specialist referral">' +
                '<span class="refer-icon">üìã</span>' +
                '<span class="refer-label">Refer</span>' +
            '</a>' +
        '</div>';

    /* Disclaimer strip */
    var disclaimer =
        '<div class="l3-disclaimer">' +
            '<span class="l3-disclaimer-icon">‚ö†Ô∏è</span>' +
            '<span class="l3-disclaimer-text"><strong>Fertool AI cannot recommend next steps.</strong> Clinical management requires specialist consultation ‚Äî use the buttons above to connect with Dr Fouks.</span>' +
        '</div>';

    return '<div class="l3-wrapper">' +
        circles +
        '<div class="l3-content">' + body + '</div>' +
        disclaimer +
    '</div>';
}

function formatResponseV2(text) {
    var cfg={GUIDELINE:{css:'guideline',label:'Guidelines'},SPECIALIST:{css:'specialist',label:'Specialist Insight'},CLINICAL:{css:'clinical',label:'Clinical Practice'}};
    var parts=text.split(/#{1,3}\s*\[(\w+)\]\s*/g);
    if(parts.length<=1) return '<div class="response-section guideline">'+formatTextV2(text)+'</div>';
    var h=''; if(parts[0].trim()) h+='<div style="margin-bottom:1rem;">'+formatTextV2(parts[0].trim())+'</div>';
    for(var i=1;i<parts.length;i+=2){ var key=parts[i].trim().toUpperCase(); var c=cfg[key]||{css:'guideline',label:key}; h+='<div class="response-section '+c.css+'"><div class="section-header '+c.css+'">'+c.label+'</div>'+formatTextV2((parts[i+1]||'').trim())+'</div>'; }
    return h;
}
function formatTextV2(t){ return t.replace(/^#{1,3}\s+(.+)$/gm,'<h4>$1</h4>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/(?:^|\n)-\s+(.+)/g,'<li>$1</li>').replace(/((?:<li>.*?<\/li>\s*)+)/g,'<ul>$1</ul>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>').replace(/^(?!<)/,'<p>').replace(/(?!>)$/,'</p>').replace(/<p>\s*<\/p>/g,''); }

function renderFooter(data) {
    var h='<div class="feedback-row"><span class="feedback-label">Was this helpful?</span><button class="feedback-btn" id="fbUp" onclick="submitFeedback(true)">üëç</button><button class="feedback-btn" id="fbDown" onclick="submitFeedback(false)">üëé</button></div>';
    if(data.latency_ms) h+='<div class="meta-row">'+data.latency_ms+'ms</div>';
    return h;
}

function renderSources(data) {
    if(!data.sources||!data.sources.length) return '';
    var seen={}, list=[];
    data.sources.forEach(function(s){
        var raw=s.source||s.name||''; if(isSpecialistChunk(raw)) return;
        var name=cleanSourceName(raw); if(!name) return;
        var key=name+'|'+(s.page||''); if(seen[key]) return; seen[key]=true;
        list.push({name:name, page:s.page||null});
    });
    if(!list.length) return '';
    var h='<div class="sources-header">References</div>';
    list.forEach(function(src,i){ h+='<div class="source-item"><span class="source-num">'+(i+1)+'.</span><span class="source-name">'+esc(src.name)+'</span>'+(src.page?'<span class="source-page"> p.'+esc(src.page)+'</span>':'')+'</div>'; });
    return h;
}

async function submitFeedback(helpful) {
    document.getElementById('fbUp').classList.toggle('active-up',helpful);
    document.getElementById('fbDown').classList.toggle('active-down',!helpful);
    try { await fetch(API_URL+'/feedback',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query_id:_lastQueryId||'no-id',query:_lastQuery,helpful:helpful,comment:'',timestamp:new Date().toISOString()})}); } catch(e){}
}

async function tryStream(query) {
    var resp=await fetch(API_URL+'/query/stream',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:query})});
    if(!resp.ok||!(resp.headers.get('content-type')||'').includes('text/event-stream')) throw new Error('no-stream');
    var reader=resp.body.getReader(), decoder=new TextDecoder(), buffer='', meta={};
    while(true){
        var chunk=await reader.read(); if(chunk.done) break;
        buffer+=decoder.decode(chunk.value,{stream:true});
        var parts=buffer.split('\n\n'); buffer=parts.pop();
        for(var p=0;p<parts.length;p++){
            var line=parts[p].trim(); if(!line.startsWith('data: ')) continue;
            var evt; try{evt=JSON.parse(line.slice(6));}catch(e){continue;}
            if(evt.type==='guidelines') revealSlot('sl-g',renderGuidelines(evt.data));
            else if(evt.type==='specialist') revealSlot('sl-s',renderSpecialist(evt.data));
            else if(evt.type==='clinical') revealSlot('sl-c',renderClinical(evt.data,evt.calculator_results||{}));
            else if(evt.type==='done') meta=evt.data||evt;
        }
    }
    return meta;
}

async function regularQuery(query) {
    var resp=await fetch(API_URL+'/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:query})});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    var data=await resp.json(); _lastQueryId=data.query_id||null;
    if(data.guidelines||data.specialist_insight||data.clinical_practice){
        revealSlot('sl-g',renderGuidelines(data.guidelines));
        setTimeout(function(){revealSlot('sl-s',renderSpecialist(data.specialist_insight));},250);
        setTimeout(function(){revealSlot('sl-c',renderClinical(data.clinical_practice,data.calculator_results||{}));},500);
    } else if(data.answer){
        revealSlot('sl-g',formatResponseV2(data.answer));
        ['sl-s','sl-c'].forEach(function(id){var el=document.getElementById(id);if(el)el.remove();});
    } else {
        revealSlot('sl-g','<p style="color:#c0392b;">Unexpected response ‚Äî please try again.</p>');
    }
    return data;
}

async function performSearch() {
    var query=document.getElementById('searchInput').value.trim(); if(!query) return;
    _lastQuery=query; _lastQueryId=null;
    startLoadingSteps(query);
    showSkeletons();
    var data={};
    try { data=await tryStream(query); }
    catch(e) {
        try { data=await regularQuery(query); }
        catch(err){
            stopLoadingSteps();
            revealSlot('sl-g','<span style="color:#c0392b;">Error: '+esc(err.message)+'. Service may be starting ‚Äî retry in 30s.</span>');
            ['sl-s','sl-c'].forEach(function(id){var el=document.getElementById(id);if(el)el.remove();});
            return;
        }
    }
    stopLoadingSteps();
    var f=document.getElementById('sl-f');
    if(f) setTimeout(function(){ f.innerHTML=renderFooter(data); document.getElementById('resultSources').innerHTML=renderSources(data); }, data.guidelines?700:100);
}
</script>
</body>
</html>
